import express from 'express';
import cors from 'cors';
import OpenAI from 'openai';
import dotenv from 'dotenv';

dotenv.config();

const app = express();
const port = 3002;

app.use(cors());
app.use(express.json());

const openai = new OpenAI({
  apiKey: process.env.DEEPSEEK_API_KEY,
  baseURL: 'https://api.deepseek.com/v1',
});

// Few-shot ç¤ºä¾‹ï¼šé«˜è´¨é‡çš„å‘¨æŠ¥æ ¼å¼
const weeklyReportExamples = [
  {
    role: "user",
    content: `ä»¥ä¸‹æ˜¯æˆ‘æœ¬å‘¨çš„å·¥ä½œè®°å½•ï¼Œè¯·å¸®æˆ‘æ•´ç†æˆå‘¨æŠ¥ï¼š

å‘¨ä¸€ï¼šå‚åŠ äº§å“éœ€æ±‚è¯„å®¡ä¼šï¼Œè®¨è®ºæ–°åŠŸèƒ½ä¼˜å…ˆçº§
å‘¨äºŒï¼šä¿®å¤ç”¨æˆ·åé¦ˆçš„ç™»å½•bugï¼ŒèŠ±äº†åŠå¤©æ—¶é—´
å‘¨ä¸‰ï¼šå¼€å‘æ”¯ä»˜é¡µé¢ï¼Œå®Œæˆäº†å‰ç«¯å¸ƒå±€
å‘¨å››ï¼šå’Œè®¾è®¡å¸ˆæ²Ÿé€šUIè°ƒæ•´æ–¹æ¡ˆï¼Œä¸‹åˆç»§ç»­å¼€å‘æ”¯ä»˜é€»è¾‘
å‘¨äº”ï¼šä¸Šåˆå†™å‘¨æŠ¥ï¼Œä¸‹åˆå›¢é˜Ÿå‘¨ä¼š`
  },
  {
    role: "assistant",
    content: `# æœ¬å‘¨å·¥ä½œå‘¨æŠ¥ï¼ˆ2024å¹´3æœˆç¬¬2å‘¨ï¼‰

## ğŸ“‹ æœ¬å‘¨å®Œæˆ
1. **éœ€æ±‚è¯„å®¡**ï¼šå‚åŠ äº§å“éœ€æ±‚è¯„å®¡ä¼šï¼Œæ˜ç¡®æ–°åŠŸèƒ½å¼€å‘ä¼˜å…ˆçº§
2. **Bugä¿®å¤**ï¼šä¿®å¤ç”¨æˆ·ç™»å½•å¼‚å¸¸é—®é¢˜ï¼Œå®šä½å¹¶è§£å†³sessionå¤±æ•ˆåŸå› 
3. **æ”¯ä»˜åŠŸèƒ½å¼€å‘**ï¼š
   - å®Œæˆæ”¯ä»˜é¡µé¢å‰ç«¯å¸ƒå±€
   - å®ç°åŸºç¡€æ”¯ä»˜é€»è¾‘
   - ä¸è®¾è®¡å¸ˆç¡®è®¤UIè°ƒæ•´æ–¹æ¡ˆ

## âš ï¸ å­˜åœ¨é—®é¢˜
- æ”¯ä»˜æµç¨‹ä¸­çš„å¼‚å¸¸å¤„ç†å°šæœªå®Œå–„ï¼Œéœ€è¦è¡¥å……è¾¹ç•Œæƒ…å†µæµ‹è¯•
- ç™»å½•bugæš´éœ²äº†ç°æœ‰sessionç®¡ç†æœºåˆ¶ä¸å¥å£®ï¼Œéœ€è€ƒè™‘ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“… ä¸‹å‘¨è®¡åˆ’
1. å®Œæˆæ”¯ä»˜åŠŸèƒ½çš„è”è°ƒæµ‹è¯•
2. è¡¥å……æ”¯ä»˜å¼‚å¸¸å¤„ç†é€»è¾‘
3. å‚ä¸æŠ€æœ¯è¯„å®¡ä¼š
4. æ•´ç†é¡¹ç›®æ–‡æ¡£`
  },
  {
    role: "user",
    content: `è®°å½•ï¼šå‘¨äºŒä¸Šåˆä¿®å¤äº†æ•°æ®åº“è¿æ¥æ± çš„bugï¼Œä¸‹åˆå†™äº†æ¥å£æ–‡æ¡£ã€‚å‘¨ä¸‰å’Œæµ‹è¯•åŒå­¦è¿‡äº†ä¸€éæµ‹è¯•ç”¨ä¾‹ï¼Œå‘ç°å‡ ä¸ªè¾¹ç•Œé—®é¢˜ã€‚å‘¨å››æ”¹bugï¼Œå‘¨äº”ä¸Šçº¿ã€‚`
  },
  {
    role: "assistant",
    content: `# æœ¬å‘¨å·¥ä½œå‘¨æŠ¥ï¼ˆ2024å¹´3æœˆç¬¬3å‘¨ï¼‰

## ğŸ“‹ æœ¬å‘¨å®Œæˆ
1. **æ•°æ®åº“ä¼˜åŒ–**ï¼šä¿®å¤è¿æ¥æ± é…ç½®é—®é¢˜ï¼Œæå‡ç³»ç»Ÿç¨³å®šæ€§
2. **æ–‡æ¡£å»ºè®¾**ï¼šå®Œæˆæ ¸å¿ƒæ¥å£çš„æŠ€æœ¯æ–‡æ¡£ç¼–å†™
3. **è´¨é‡ä¿éšœ**ï¼š
   - ä¸æµ‹è¯•å›¢é˜Ÿè¯„å®¡æµ‹è¯•ç”¨ä¾‹ï¼Œå‘ç°å¹¶ä¿®å¤5ä¸ªè¾¹ç•Œé—®é¢˜
   - å®Œæˆç‰ˆæœ¬è¿­ä»£ï¼Œå‘¨äº”é¡ºåˆ©ä¸Šçº¿

## âš ï¸ å­˜åœ¨é—®é¢˜
- æµ‹è¯•ç”¨ä¾‹è¯„å®¡ä¸­å‘ç°éƒ¨åˆ†æ¥å£ç¼ºä¹å¼‚å¸¸å¤„ç†ï¼Œå·²è¡¥å……å®Œå–„
- ä¸Šçº¿å‰å‘ç°ç¯å¢ƒé…ç½®å·®å¼‚ï¼Œéœ€è¦è§„èŒƒåŒ–éƒ¨ç½²æµç¨‹

## ğŸ“… ä¸‹å‘¨è®¡åˆ’
1. ç›‘æ§ä¸Šçº¿åç³»ç»Ÿè¿è¡ŒçŠ¶æ€
2. å¤„ç†å¯èƒ½å‡ºç°çš„çº¿ä¸Šé—®é¢˜
3. å¼€å§‹ä¸‹ä¸€ç‰ˆæœ¬çš„éœ€æ±‚é¢„ç ”`
  }
];

app.post('/api/generate-report', async (req, res) => {
  const { notes } = req.body;

  if (!notes) {
    return res.status(400).json({ error: 'è¯·æä¾›å·¥ä½œè®°å½•' });
  }

  try {
    const userQuery = {
      role: "user",
      content: `ä»¥ä¸‹æ˜¯æˆ‘æœ¬å‘¨çš„å·¥ä½œè®°å½•ï¼Œè¯·æŒ‰ç…§ç¤ºä¾‹çš„æ ¼å¼å¸®æˆ‘ç”Ÿæˆå‘¨æŠ¥ï¼š\n\n${notes}`
    };

    const completion = await openai.chat.completions.create({
      model: 'deepseek-chat',
      messages: [
        { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å‘¨æŠ¥ç”ŸæˆåŠ©æ‰‹ã€‚ä¸¥æ ¼éµå¾ªç¤ºä¾‹ä¸­çš„æ ¼å¼å’Œé£æ ¼ï¼Œè¾“å‡ºç»“æ„æ¸…æ™°çš„å‘¨æŠ¥ã€‚ä½¿ç”¨åˆé€‚çš„emojiå¢å¼ºå¯è¯»æ€§ã€‚' },
        ...weeklyReportExamples,
        userQuery
      ],
      temperature: 0.4,
    });

    const report = completion.choices[0].message.content;
    res.json({ report });
    
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'ç”Ÿæˆå¤±è´¥', detail: error.message });
  }
});

app.listen(port, () => {
  console.log(`å‘¨æŠ¥ç”Ÿæˆå™¨è¿è¡Œåœ¨ https://my-first-ai-app-eight.vercel.app`);
});